<IfModule mod_ssl.c>
    <VirtualHost *:443>
        ServerAdmin webmaster@localhost
        DocumentRoot /srv/exp/jka/templates
        ServerAlias rootairs.com

        <Directory /srv/exp/jka/templates>
            DirectoryIndex main/main.html
            Options -Indexes -FollowSymLinks
            AllowOverride None
            Require all granted
        </Directory>

        # CORS 설정 (중복된 헤더 설정 방지)
        <IfModule mod_headers.c>
            Header always set Access-Control-Allow-Origin "https://www.rootairs.com:62080"
            Header always set Access-Control-Allow-Credentials "true"
            Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
            Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
        </IfModule>

        # Static files
        Alias /static/ "/srv/exp/jka/static/"
        <Directory /srv/exp/jka/static>
            Options -Indexes -FollowSymLinks
            AllowOverride None
            Require all granted
        </Directory>

        # Uploads directory
        Alias /uploads/ "/srv/exp/jka/uploads/"
        <Directory "/srv/exp/jka/uploads">
            Options -FollowSymLinks
            AllowOverride None
            Require all granted
            <FilesMatch "\.(php|sh|exe|cgi)$">
                Require all denied
            </FilesMatch>
            <FilesMatch "\.(png|jpg|jpeg|gif|pdf|txt|csv|mp4|mp3)$">
                Header set Content-Disposition "attachment"
            </FilesMatch>
        </Directory>

        # Rewrite rules for clean URLs
        RewriteEngine On
        RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_URI}.html -f
        RewriteRule ^(.+)$ /%{REQUEST_URI}.html [L]
        RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_URI}/$1.html -f
        RewriteRule ^([^/]+)/$ /$1/$1.html [L]

        # Flask API Proxy
        ProxyPass "/api" "http://10.0.3.150:5000/api"
        ProxyPassReverse "/api" "http://10.0.3.150:5000/api"

        # Proxy settings to allow access to /api
        <Proxy *>
            Require all granted
        </Proxy>

        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
        RequestHeader set X-Forwarded-Proto "https"

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # SSL Settings
        SSLCertificateFile /etc/letsencrypt/live/www.rootairs.com/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/www.rootairs.com/privkey.pem
        Include /etc/letsencrypt/options-ssl-apache.conf
    </VirtualHost>

    <VirtualHost *:62080>
        ServerName www.rootairs.com
        DocumentRoot /srv/exp/jka/admin/templates

        <Directory /srv/exp/jka/admin/templates>
            DirectoryIndex admin.html
            Options -Indexes -FollowSymLinks
            AllowOverride None
            Require all granted
        </Directory>

        Alias /static/ "/srv/exp/jka/admin/static/"
        <Directory /srv/exp/jka/admin/static>
            Options -Indexes -FollowSymLinks
            AllowOverride None
            Require all granted
        </Directory>

        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
        RequestHeader set X-Forwarded-Proto "https"

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        ProxyPass "/api" "http://10.0.3.150:5000/api"
        ProxyPassReverse "/api" "http://10.0.3.150:5000/api"

        SSLCertificateFile /etc/letsencrypt/live/www.rootairs.com/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/www.rootairs.com/privkey.pem
        Include /etc/letsencrypt/options-ssl-apache.conf
    </VirtualHost>
</IfModule>

